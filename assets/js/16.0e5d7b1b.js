(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{283:function(s,e,n){"use strict";n.r(e);var a=n(0),r=Object(a.a)({},function(){var s=this,e=s.$createElement,n=s._self._c||e;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h2",{attrs:{id:"问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#问题","aria-hidden":"true"}},[s._v("#")]),s._v(" 问题")]),s._v(" "),n("p",[s._v("当我们访问一个图片不是来源与我们的服务器时，并且对方图片服务器做了防盗链机制。"),n("br"),s._v("\n我们防卫图片就可能会变成403,不能正常访问。")]),s._v(" "),n("h2",{attrs:{id:"防盗链原理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#防盗链原理","aria-hidden":"true"}},[s._v("#")]),s._v(" 防盗链原理")]),s._v(" "),n("p",[s._v("http协议中，从一个网页跳到另一个网页中，http头字段会带有Referer，图片服务器通过检测Referer是否来自规定域名，来进行防盗链。")]),s._v(" "),n("h2",{attrs:{id:"破解防盗链"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#破解防盗链","aria-hidden":"true"}},[s._v("#")]),s._v(" 破解防盗链")]),s._v(" "),n("p",[s._v("1.referer为空"),n("br"),s._v("\n若不发送Referer,也就没有来源，图片服务器就会认为是浏览器直接访问的，可以正常加载图片。")]),s._v(" "),n("pre",[n("code",[s._v("a:https访问http，如果盗用图片的网站是https，而图片链接是http的话，从https向http发送请求因为  \n\n安全规定，而不带referer,实现绕过防盗链。\n\nb:若开启隐私模式的浏览器，在https页面的引用下，referer是空的\n\nc:设置请求头\n")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("    Nodejs:\nres.writeHead(200, {\n    'Content-Type': 'image/*'\n});\nlet url = req.query.url;\nif (!url) {\n    res.send(\"\");\n    return false;\n}\nsuperagent.get(req.query.url)\n    .set('Referer', '')\n    .set(\"User-Agent\",\n        'User-Agent:Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.80 Safari/537.36 Core/1.47.933.400 QQBrowser/9.4.8699.400'\n    )\n    .end(function(err, result) {\n        if (err) {\n            //res.send(err);\n            return false;\n        }\n        res.end(result.body);\n        return;\n    });\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br")])]),n("p",[s._v("2.用iFrame伪造请求referer")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("function showImg( url ) {\n        var frameid = 'frameimg' + Math.random();\n        window.img = '<img id=\"img\" src=\\''+url+'?'+Math.random()+'\\' /><script>window.onload = function() { parent.document.getElementById(\\''+frameid+'\\').height = document.getElementById(\\'img\\').height+\\'px\\'; }<'+'/script>';\n        document.write('<iframe id=\"'+frameid+'\" src=\"javascript:parent.img;\" frameBorder=\"0\" scrolling=\"no\" width=\"100%\"></iframe>');\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("3.meta标签控制referer")]),s._v(" "),n("p",[s._v("设置："),n("code",[s._v('<meta name="referrer" content="never">')]),s._v(" 页面请求不会带上referer")]),s._v(" "),n("h2",{attrs:{id:"防御防盗链"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#防御防盗链","aria-hidden":"true"}},[s._v("#")]),s._v(" 防御防盗链")]),s._v(" "),n("p",[s._v("1.不允许referer为空 （不建议，因在某些开启隐私模式的浏览器中，或https页面引用下，referer是空的）"),n("br"),s._v("\n2、地址变更（lighttpd的是根据有效时间，nginx的根据是md5，IP地址变化）"),n("br"),s._v("\n　 3、登录校验（如必须登录网站帐号后才能访问）")]),s._v(" "),n("h2",{attrs:{id:"防置网站被iframe"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#防置网站被iframe","aria-hidden":"true"}},[s._v("#")]),s._v(" 防置网站被iframe")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("<script type=”text/javascript> \nif(window!=parent) \nwindow.top.location.href = window.location.href; \n< /script> \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("h2",{attrs:{id:"demo"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#demo","aria-hidden":"true"}},[s._v("#")]),s._v(" Demo")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("var express = require('express'),\n  path = require('path'),\n  app = express();\n  \nvar AntiLeech = require('express-anti-leech');\n\n// 允许引用的域名白名单\nvar hosts = ['localhost', 'localhost:8004'];\n\n// 反盗链类型\nvar exts = ['.png', '.jpg', '.jpeg', '.gif', '.swf', '.flv'];\n\n// 盗链默认指向图片\nvar pictrue = \"/images/default.png\";\n\napp.use(AntiLeech({\n  allow: hosts,\n  exts: exts,\n  log: console.log, // 你也可以使用自己的方法来记录\n  default: pictrue\n}));\n\n// 请在调用静态资源之前先使用反盗链模块\napp.use(express.static(path.join(__dirname, 'public')));\napp.set('port', process.env.PORT || 8004);\n\napp.get('/', function(req, res) {\n  res.redirect(\"/index.html\");\n});\n\napp.listen(app.get('port'), function() {\n  console.log(\"Express test server listening on http://localhost:\" + app.get('port'));\n});\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br")])]),n("h2",{attrs:{id:"nginx防盗链"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nginx防盗链","aria-hidden":"true"}},[s._v("#")]),s._v(" nginx防盗链")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("location ~* \\.(gif|jpg|png|bmp)$ {\n  valid_referers none blocked *.xxx.com server_names ~\\.google\\. ~\\.baidu\\.;\n  if ($invalid_referer) {\n      return 403;\n      #rewrite ^/ http://www.xxx.com/403.jpg;\n  }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])])])},[],!1,null,null,null);e.default=r.exports}}]);